<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Retrieve Patient – Patient Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #12346e;
      --accent: #38bdf8;
      --card-bg: rgba(255,255,255,0.92);
      --card-bg-dark: rgba(24,29,40,0.96);
      --bg: #f2f7fa;
      --bg-dark: #141a26;
      --radius: 1.1rem;
      --shadow: 0 4px 24px rgba(37,99,235,0.07);
      --transition: 0.3s;
      --glass: blur(9px);
    }
    body {
      background: var(--bg);
      font-family: 'Source Sans Pro', sans-serif;
      min-height: 100vh;
      color: #28334b;
      transition: background var(--transition), color var(--transition);
    }
    body.dark-mode {
      background: var(--bg-dark);
      color: #eceff4;
    }
    .navbar {
      background: #fff;
      box-shadow: var(--shadow);
      border-bottom: 1px solid #e5eaf3;
      transition: background var(--transition);
    }
    .navbar.dark-mode { background: #232e47; }
    .navbar-brand {
      color: var(--primary-dark);
      font-weight: 700;
      letter-spacing: 0.5px;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      transition: color var(--transition);
    }
    .theme-toggle {
      background: none;
      border: none;
      font-size: 1.3rem;
      cursor: pointer;
      margin-left: 13px;
      color: var(--primary);
    }
    .theme-toggle:hover {
      color: var(--accent);
    }
    .page-title {
      margin-top: 2.5rem;
      margin-bottom: 2rem;
      text-align: center;
      color: var(--primary-dark);
      font-size: 2rem;
      letter-spacing: 1.2px;
      font-weight: 800;
    }
    .glass-card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 2rem 2.2rem;
      margin-bottom: 2.2rem;
      -webkit-backdrop-filter: var(--glass);
      backdrop-filter: var(--glass);
      border: 1px solid rgba(56, 189, 248, 0.07);
      transition: background var(--transition);
    }
    body.dark-mode .glass-card {
      background: var(--card-bg-dark);
      border: 1px solid rgba(37, 99, 235, 0.13);
    }
    .section-card {
      margin-bottom: 2rem;
    }
    .form-control, .form-select, textarea {
      border-radius: 0.55rem;
      border: 1.5px solid #e5e7eb;
      transition: border 0.18s;
      margin-bottom: 0.35rem;
      font-size: 1rem;
    }
    .form-control:focus, .form-select:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2.5px rgba(37,99,235,0.08);
    }
    .btn-primary, .btn-gradient {
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border: none;
      color: #fff;
      padding: 0.62rem 1.80rem;
      border-radius: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.5px;
      font-size: 1.05rem;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 3px 12px rgba(37,99,235,0.06);
    }
    .btn-gradient:hover {
      background: linear-gradient(90deg, var(--accent), var(--primary));
      color: #fff;
    }
    .btn-edit, .btn-save {
      background: linear-gradient(90deg,#fb7185 30%,#38bdf8 100%);
      color: #fff;
      border: none;
      font-weight: 600;
      border-radius: 0.55rem;
      padding: 0.52rem 1.2rem;
      margin-left: 6px;
      transition: background 0.18s;
    }
    .btn-edit:hover, .btn-save:hover {
      background: linear-gradient(60deg,#38bdf8,#fb7185 60%);
    }
    .d-grid .btn, .d-grid .btn-gradient, .d-grid .btn-primary {
      margin: 0.5rem 0 0 0;
      width: 100%;
    }
    label.form-label {
      font-weight: 700;
    }
    .visit-history-header {
      color: var(--primary-dark);
      font-size: 1.20rem;
      font-weight: 700;
      letter-spacing: 0.05rem;
      background: var(--accent);
      padding: 0.5rem 1rem 0.5rem 1.1rem;
      border-radius: 0.7rem;
      margin-bottom: 1rem;
      display: inline-block;
    }
    .visit-card {
      background: #f6f9fb;
      border-radius: 0.8rem;
      margin-bottom: 1.1rem;
      padding: 1.25rem 1.1rem;
      border: 1px solid #e0e7ef;
    }
    body.dark-mode .visit-card {
      background: #202d40;
      border: 1px solid #223046;
    }
    .modal-content {
      border-radius: 1rem;
      background: var(--card-bg);
      transition: background var(--transition);
    }
    body.dark-mode .modal-content {
      background: var(--card-bg-dark);
    }
    .footer {
      padding: 1.5rem 0 0.9rem 0;
      text-align: center;
      color: #6c8bad;
      font-size: 0.97rem;
    }
    @media (max-width: 600px) {
      .glass-card, .visit-card {padding: 1.2rem 0.6rem;}
      .page-title {font-size: 1.25rem;}
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="{{ url_for('index') }}">
        <i class="fa-solid fa-hospital-user"></i>Patient Hub
      </a>
      <div class="d-flex align-items-center">
        <a href="{{ url_for('index') }}" class="btn btn-link" style="color:var(--primary); font-weight:600;">Back to Home</a>
        <button class="theme-toggle" id="theme-toggle">🌙</button>
      </div>
    </div>
  </nav>
  <!-- Title -->
  <div class="page-title">
    <i class="fa-solid fa-magnifying-glass me-1"></i>Retrieve Patient
  </div>
  <main class="container">

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="container my-3">
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'danger' else 'success' }} alert-dismissible fade show glass-card" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <!-- Search Card -->
    <div class="glass-card section-card">
      <form method="POST" class="needs-validation" id="searchForm" novalidate autocomplete="off" action="{{ url_for('retrieve_patient') }}">
        {{ form.csrf_token }} <!-- CSRF token for Flask-WTF -->
        <div class="row mb-2 align-items-center">
          <div class="col-sm-8 col-12 mb-2">
            <label for="vhid" class="form-label">Enter VHID</label>
            <input type="text" name="vhid" id="vhid" class="form-control"
              placeholder="e.g. VHID-123456"
              value="{{ request.form.vhid if request.method == 'POST' else request.args.get('vhid', '') }}" required>
            <div class="invalid-feedback">Please enter a valid VHID.</div>
          </div>
          <div class="col-sm-4 col-12 d-grid">
            <button type="submit" class="btn btn-gradient mt-2 mt-sm-4">
              <i class="fa-solid fa-search me-1"></i>Search
            </button>
          </div>
        </div>
      </form>
    </div>

    {% if patient %}
    <!-- Patient Details Card -->
    <div class="glass-card section-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4><i class="fa-solid fa-user-injured"></i> Patient Details</h4>
        <button class="btn btn-edit" data-bs-toggle="modal" data-bs-target="#editPatientModal">
          <i class="fa-solid fa-edit me-1"></i>Edit
        </button>
      </div>
      <div class="row">
        <div class="col-sm-6 col-md-3 mb-2"><strong>VHID:</strong><br>{{ patient.vhid or '-' }}</div>
        <div class="col-sm-6 col-md-3 mb-2"><strong>Date:</strong><br>{{ patient.date or '-' }}</div>
        <div class="col-sm-6 col-md-3 mb-2"><strong>Name:</strong><br>{{ patient.name or '-' }}</div>
        <div class="col-sm-6 col-md-3 mb-2"><strong>Age:</strong><br>{{ patient.age or '-' }}</div>
        <div class="col-sm-6 col-md-3 mb-2"><strong>Gender:</strong><br>{{ patient.gender or '-' }}</div>
        <div class="col-sm-6 col-md-3 mb-2"><strong>Mobile:</strong><br>{{ patient.mobile or '-' }}</div>
        <div class="col-sm-6 col-md-6 mb-2"><strong>Referred By:</strong><br>{{ patient.ref_by or '-' }}</div>
        <div class="col-12 mb-2"><strong>Address:</strong><br>{{ patient.address or '-' }}</div>
        <div class="col-12 mb-2"><strong>Past History:</strong><br>{{ patient.past_history or '-' }}</div>
        <div class="col-12 mb-2"><strong>Drug History:</strong><br>{{ patient.drug_history or '-' }}</div>
        <div class="col-12 mb-2"><strong>Surgical History:</strong><br>{{ patient.surgical_history or '-' }}</div>
      </div>
    </div>

    <!-- Edit Patient Modal -->
    <div class="modal fade" id="editPatientModal" tabindex="-1" aria-labelledby="editPatientModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="editPatientModalLabel">
              <i class="fa-solid fa-edit me-2"></i>Edit Patient Details
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form method="POST" action="{{ url_for('edit_patient', vhid=patient.vhid) }}" class="needs-validation" novalidate>
            {{ form.csrf_token }} <!-- CSRF token for Flask-WTF -->
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="edit_date" class="form-label">Date <span class="text-danger">*</span></label>
                  <input type="date" name="date" id="edit_date" class="form-control" value="{{ patient.date or '' }}" required>
                  <div class="invalid-feedback">Please enter a valid date.</div>
                </div>
                <div class="col-md-6">
                  <label for="edit_name" class="form-label">Name <span class="text-danger">*</span></label>
                  <input type="text" name="name" id="edit_name" class="form-control" value="{{ patient.name or '' }}" required>
                  <div class="invalid-feedback">Please enter the patient's name.</div>
                </div>
                <div class="col-md-6">
                  <label for="edit_age" class="form-label">Age</label>
                  <input type="number" name="age" id="edit_age" class="form-control" min="0" max="150" value="{{ patient.age or '' }}">
                  <div class="invalid-feedback">Please enter a valid age (0-150).</div>
                </div>
                <div class="col-md-6">
                  <label for="edit_gender" class="form-label">Gender <span class="text-danger">*</span></label>
                  <select name="gender" id="edit_gender" class="form-select" required>
                    <option value="" disabled {% if not patient.gender %}selected{% endif %}>Select</option>
                    <option value="Male" {% if patient.gender == 'Male' %}selected{% endif %}>Male</option>
                    <option value="Female" {% if patient.gender == 'Female' %}selected{% endif %}>Female</option>
                    <option value="Other" {% if patient.gender == 'Other' %}selected{% endif %}>Other</option>
                  </select>
                  <div class="invalid-feedback">Please select a gender.</div>
                </div>
                <div class="col-md-6">
                  <label for="edit_mobile" class="form-label">Mobile</label>
                  <input type="tel" name="mobile" id="edit_mobile" class="form-control" pattern="[0-9]{10}" value="{{ patient.mobile or '' }}">
                  <div class="invalid-feedback">Please enter a valid 10-digit mobile number.</div>
                </div>
                <div class="col-md-6">
                  <label for="edit_ref_by" class="form-label">Referred By</label>
                  <input type="text" name="ref_by" id="edit_ref_by" class="form-control" value="{{ patient.ref_by or '' }}">
                </div>
                <div class="col-12">
                  <label for="edit_address" class="form-label">Address</label>
                  <textarea name="address" id="edit_address" class="form-control" rows="2">{{ patient.address or '' }}</textarea>
                </div>
                <div class="col-12">
                  <label for="edit_past_history" class="form-label">Past History</label>
                  <textarea name="past_history" id="edit_past_history" class="form-control" rows="2">{{ patient.past_history or '' }}</textarea>
                </div>
                <div class="col-12">
                  <label for="edit_drug_history" class="form-label">Drug History</label>
                  <textarea name="drug_history" id="edit_drug_history" class="form-control" rows="2">{{ patient.drug_history or '' }}</textarea>
                </div>
                <div class="col-12">
                  <label for="edit_surgical_history" class="form-label">Surgical History</label>
                  <textarea name="surgical_history" id="edit_surgical_history" class="form-control" rows="2">{{ patient.surgical_history or '' }}</textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-save">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Visit History Card -->
    <div class="glass-card section-card">
      <div class="visit-history-header"><i class="fa-solid fa-clock-rotate-left me-2"></i>Visit History</div>
      {% if visits %}
        {% for visit in visits %}
        <div class="visit-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div>
              <strong>Visit Date:</strong> {{ visit.date or 'N/A' }}
            </div>
            <button class="btn btn-edit btn-sm" data-bs-toggle="modal" data-bs-target="#editVisitModal{{ visit.id }}">
              <i class="fa-solid fa-edit me-1"></i>Edit
            </button>
          </div>
          <div class="mb-2"><strong>Vitals:</strong><br>{{ visit.vitals or '-' }}</div>
          <div class="mb-2"><strong>Complaints:</strong><br>{{ visit.complaints or '-' }}</div>
          <div class="mb-2"><strong>OE:</strong><br>{{ visit.oe or '-' }}</div>
          <div class="mb-2"><strong>IMP:</strong><br>{{ visit.imp or '-' }}</div>
          <div class="mb-2"><strong>Investigations:</strong><br>{{ visit.invgs or '-' }}</div>
          <div class="mb-2"><strong>Treatment:</strong><br>{{ visit.treatment or '-' }}</div>
          <div class="mb-2"><strong>Next Review:</strong><br>{{ visit.next_review or '-' }}</div>
        </div>

        <!-- Edit Visit Modal -->
        <div class="modal fade" id="editVisitModal{{ visit.id }}" tabindex="-1" aria-labelledby="editVisitModalLabel{{ visit.id }}" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="editVisitModalLabel{{ visit.id }}">
                  <i class="fa-solid fa-edit me-2"></i>Edit Visit Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form method="POST" action="{{ url_for('edit_visit', visit_id=visit.id) }}" class="needs-validation" novalidate>
                {{ form.csrf_token }} <!-- CSRF token for Flask-WTF -->
                <input type="hidden" name="vhid" value="{{ patient.vhid or '' }}"> <!-- Hidden VHID for redirect -->
                <div class="modal-body">
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label for="edit_visit_date{{ visit.id }}" class="form-label">Date <span class="text-danger">*</span></label>
                      <input type="date" name="date" id="edit_visit_date{{ visit.id }}" class="form-control"
                             value="{{ visit.date or '' }}" required>
                      <div class="invalid-feedback">Please enter a valid date.</div>
                    </div>
                    <div class="col-md-6">
                      <label for="edit_vitals{{ visit.id }}" class="form-label">Vitals</label>
                      <input type="text" name="vitals" id="edit_vitals{{ visit.id }}" class="form-control"
                             value="{{ visit.vitals or '' }}">
                    </div>
                    <div class="col-md-12">
                      <label for="edit_complaints{{ visit.id }}" class="form-label">Complaints <span class="text-danger">*</span></label>
                      <textarea name="complaints" id="edit_complaints{{ visit.id }}" class="form-control" rows="3" required>{{ visit.complaints or '' }}</textarea>
                      <div class="invalid-feedback">Please enter complaints.</div>
                    </div>
                    <div class="col-md-6">
                      <label for="edit_oe{{ visit.id }}" class="form-label">OE</label>
                      <textarea name="oe" id="edit_oe{{ visit.id }}" class="form-control" rows="3">{{ visit.oe or '' }}</textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="edit_imp{{ visit.id }}" class="form-label">IMP</label>
                      <textarea name="imp" id="edit_imp{{ visit.id }}" class="form-control" rows="3">{{ visit.imp or '' }}</textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="edit_invgs{{ visit.id }}" class="form-label">Investigations</label>
                      <input type="text" name="invgs" id="edit_invgs{{ visit.id }}" class="form-control"
                             value="{{ visit.invgs or '' }}">
                    </div>
                    <div class="col-md-6">
                      <label for="edit_treatment{{ visit.id }}" class="form-label">Treatment</label>
                      <textarea name="treatment" id="edit_treatment{{ visit.id }}" class="form-control" rows="3">{{ visit.treatment or '' }}</textarea>
                    </div>
                    <div class="col-md-6">
                      <label for="edit_next_review{{ visit.id }}" class="form-label">Next Review</label>
                      <input type="date" name="next_review" id="edit_next_review{{ visit.id }}" class="form-control"
                             value="{{ visit.next_review or '' }}">
                    </div>
                    <div class="col-12" style="display: none;">
                      <label class="form-label">Past History</label>
                      <textarea name="past_history" class="form-control" rows="2">{{ visit.past_history or '' }}</textarea>
                    </div>
                    <div class="col-12" style="display: none;">
                      <label class="form-label">Drug History</label>
                      <textarea name="drug_history" class="form-control" rows="2">{{ visit.drug_history or '' }}</textarea>
                    </div>
                    <div class="col-12" style="display: none;">
                      <label class="form-label">Surgical History</label>
                      <textarea name="surgical_history" class="form-control" rows="2">{{ visit.surgical_history or '' }}</textarea>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                  <button type="submit" class="btn btn-save">Save Changes</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="visit-card text-center">
        <p class="text-muted mb-0">No visit history found for this patient.</p>
      </div>
      {% endif %}
    </div>

    <!-- Add New Visit Card -->
    <div class="glass-card section-card">
      <h4 class="text-center mb-3"><i class="fa-solid fa-plus me-2"></i>Add New Visit</h4>
      <form method="POST" action="{{ url_for('add_visit', vhid=patient.vhid) }}" class="needs-validation" id="visitForm" novalidate>
        {{ form.csrf_token }} <!-- CSRF token for Flask-WTF -->
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label">Date <span class="text-danger">*</span></label>
            <input type="date" name="date" class="form-control" required>
            <div class="invalid-feedback">Please enter a valid date.</div>
          </div>
          <div class="col-md-9">
            <label class="form-label">Vitals</label>
            <input type="text" name="vitals" class="form-control">
          </div>
          <div class="col-md-12">
            <label class="form-label">Complaints <span class="text-danger">*</span></label>
            <textarea name="complaints" class="form-control" rows="3" required></textarea>
            <div class="invalid-feedback">Please enter complaints.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">OE</label>
            <textarea name="oe" class="form-control" rows="3"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">IMP</label>
            <textarea name="imp" class="form-control" rows="3"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Investigations</label>
            <input type="text" name="invgs" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">Treatment</label>
            <textarea name="treatment" class="form-control" rows="3"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Next Review</label>
            <input type="date" name="next_review" class="form-control">
          </div>
          <div class="col-12" style="display: none;">
            <label class="form-label">Past History</label>
            <textarea name="past_history" class="form-control" rows="2"></textarea>
          </div>
          <div class="col-12" style="display: none;">
            <label class="form-label">Drug History</label>
            <textarea name="drug_history" class="form-control" rows="2"></textarea>
          </div>
          <div class="col-12" style="display: none;">
            <label class="form-label">Surgical History</label>
            <textarea name="surgical_history" class="form-control" rows="2"></textarea>
          </div>
        </div>
        <div class="text-center mt-4">
          <button type="submit" class="btn btn-primary btn-gradient btn-save"><i class="fa-solid fa-floppy-disk me-1"></i>Save Visit</button>
        </div>
      </form>
    </div>
    {% endif %}
  </main>
  <div class="footer">
    © 2025 Patient Hub | Built with Flask & Bootstrap 5
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Set today's date as default for date inputs
    const dateInputs = document.querySelectorAll('input[type="date"]');
    dateInputs.forEach(input => {
      if (!input.value) {
        input.value = new Date().toISOString().split('T')[0];
      }
    });
    // Theme toggle
    const themeToggle = document.getElementById('theme-toggle');
    const body = document.body;
    if (localStorage.getItem('darkMode') === 'true') {
      body.classList.add('dark-mode');
      themeToggle.textContent = '☀️';
    }
    themeToggle.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      const isDark = body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDark);
      themeToggle.textContent = isDark ? '☀️' : '🌙';
    });
    // Bootstrap validation
    (() => {
      'use strict';
      const forms = document.querySelectorAll('.needs-validation');
      Array.from(forms).forEach(form => {
        form.addEventListener('submit', event => {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
    })();
  </script>
</body>
</html>